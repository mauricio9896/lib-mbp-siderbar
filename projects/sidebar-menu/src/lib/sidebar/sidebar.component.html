<aside class="sidebar" [class.collapsed]="collapsed" [class.mobile-open]="mobileOpen">
  <!-- HEADER -->
  <div class="sidebar__header">
    <div class="brand">
      @if (logoUrl) {
      <div class="brand__logo-wrapper">
        <img [src]="logoUrl" [alt]="title" class="brand__logo" />
      </div>
      }

      <div class="brand__info" [class.visible]="!collapsed">
        <span class="brand__title">{{ title }}</span>
        @if (subtitle) {
          <span class="brand__subtitle">{{ subtitle }}</span>
        }
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <nav class="sidebar__content custom-scrollbar">
    <ul class="menu-list">
      <ng-container
        *ngTemplateOutlet="menuTemplate; context: { $implicit: items, level: 0 }"
      ></ng-container>
    </ul>
  </nav>

  <!-- FOOTER -->
  <div class="sidebar__footer">
    <div class="footer-actions">
        <button
          class="sidebar-toggle-btn"
          type="button"
          (click)="toggleCollapse()"
          [attr.aria-label]="collapsed ? 'Expand sidebar' : 'Collapse sidebar'"
          matRipple
        >
        <mat-icon>{{ collapsed ? 'menu_open' : 'chevron_left' }}</mat-icon>
      </button>
    </div>
  </div>
</aside>

<!-- BACKDROP FOR MOBILE -->
@if (mobileOpen) {
  <div class="sidebar-backdrop" (click)="closeMobile()"></div>
}

<!-- RECURSIVE TEMPLATE -->
<ng-template #menuTemplate let-menuItems let-level="level">
  @for (item of menuItems; track trackById($index, item)) {
    <li
      class="menu-item"
      [class.active]="isItemActive(item)"
      [class.disabled]="item.disabled"
      [class.has-children]="item.children?.length"
      [class.expanded]="isExpanded(item)"
      [attr.data-level]="level"
    >
      <!-- ITEM ROW -->
      <div
        class="menu-link-wrapper"
        [class.parent-active]="isExpanded(item) && !collapsed"
        matRipple
        [matRippleDisabled]="item.disabled"
        [matTooltip]="collapsed && level === 0 ? item.label : ''"
        matTooltipPosition="right"
        [matTooltipClass]="'sidebar-tooltip ' + overlayThemeClass"
        [matMenuTriggerFor]="(collapsed && item.children?.length) ? childMenu : null"
      >
        <!-- Selection Indicator Bar -->
        <div class="active-indicator"></div>

        <a
          class="menu-link"
          [routerLink]="item.route || null"
          routerLinkActive="route-active"
          [attr.href]="!item.route ? item.url || null : null"
          (click)="onItemClick(item, $event)"
        >
          @if (item.icon) {
            <mat-icon class="menu-icon">{{ item.icon }}</mat-icon>
          }

          <span class="menu-label" [class.visible]="!collapsed">
            {{ item.label }}
          </span>

          @if (!collapsed) {
             <div class="spacer"></div>

             @if (item.badge) {
               <span class="menu-badge" [class]="item.badgeClass || 'badge-default'">
                 {{ item.badge }}
               </span>
             }

             @if (item.children?.length) {
               <mat-icon class="menu-chevron" [class.rotated]="isExpanded(item)">
                 expand_more
               </mat-icon>
             }
          }
        </a>
      </div>

      <!-- Collapsed Menu Dropdown Structure -->
      <!-- Moved outside @if so the template reference #childMenu always exists -->
      <mat-menu #childMenu="matMenu" [class]="'sidebar-popup-menu ' + overlayThemeClass">
        @if (item.children?.length) {
          <ng-container *ngTemplateOutlet="matMenuRecursive; context: { $implicit: item.children }"></ng-container>
        }
      </mat-menu>

      <!-- SUBMENU (Standard) -->
      @if (item.children?.length && isExpanded(item) && !collapsed) {
        <ul class="submenu" [@slideDown]>
          <ng-container
            *ngTemplateOutlet="menuTemplate; context: { $implicit: item.children, level: level + 1 }"
          ></ng-container>
        </ul>
      }
    </li>
  }
</ng-template>

<!-- RECURSIVE MAT-MENU TEMPLATE -->
<ng-template #matMenuRecursive let-items>
  @for (child of items; track trackById($index, child)) {
    @if (child.children?.length) {
      <button mat-menu-item [matMenuTriggerFor]="grandChildMenu" [disabled]="child.disabled">
        @if (child.icon) {
          <mat-icon>{{ child.icon }}</mat-icon>
        }
        <span>{{ child.label }}</span>
      </button>
      <mat-menu #grandChildMenu="matMenu" [class]="'sidebar-popup-menu ' + overlayThemeClass" xPosition = "after" >
        <ng-container *ngTemplateOutlet="matMenuRecursive; context: { $implicit: child.children }"></ng-container>
      </mat-menu>
    } @else {
      <button mat-menu-item
              [routerLink]="child.route || null"
              [class.active-menu-item]="isItemActive(child)"
              [disabled]="child.disabled"
              (click)="onSelect(child, $event)">
        @if (child.icon) {
          <mat-icon>{{ child.icon }}</mat-icon>
        }
        <span>{{ child.label }}</span>
      </button>
    }
  }
</ng-template>
