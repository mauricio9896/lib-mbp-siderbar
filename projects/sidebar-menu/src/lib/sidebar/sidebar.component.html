<aside class="sidebar" [class.collapsed]="collapsed()" [class.mobile-open]="mobileOpenState()">
  <!-- HEADER -->
  <div class="sidebar__header">
    <div class="brand">
      @if (logoUrl()) {
      <div class="brand__logo-wrapper">
        <img [src]="logoUrl()" [alt]="title()" class="brand__logo" />
      </div>
      }

      <div class="brand__info" [class.visible]="!collapsed()">
        <span class="brand__title">{{ title() }}</span>
        @if (subtitle()) {
          <span class="brand__subtitle">{{ subtitle() }}</span>
        }
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <nav class="sidebar__content custom-scrollbar" (scroll)="onCollapsedScroll()">
    <ul class="menu-list">
      <ng-container
        *ngTemplateOutlet="menuTemplate; context: { $implicit: items(), level: 0 }"
      ></ng-container>
    </ul>
  </nav>

  <!-- FOOTER -->
  <div class="sidebar__footer">
    <div class="footer-actions">
      @if (!mobileOpenState()) {
        <button
          class="sidebar-toggle-btn"
          type="button"
          (click)="toggleCollapse()"
          [attr.aria-label]="collapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
          matRipple
        >
        <mat-icon>{{ collapsed() ? 'menu_open' : 'chevron_left' }}</mat-icon>
      </button>
      }
    </div>
  </div>
</aside>

<!-- BACKDROP FOR MOBILE -->
@if (mobileOpenState()) {
  <div class="sidebar-backdrop" (click)="closeMobile()"></div>
}

<!-- RECURSIVE TEMPLATE -->
<ng-template #menuTemplate let-menuItems let-level="level">
  @for (item of menuItems; track trackById($index, item)) {
    <li
      class="menu-item"
      [class.active]="isItemActive(item)"
      [class.disabled]="item.disabled"
      [class.has-children]="item.children?.length"
      [class.expanded]="isExpanded(item)"
      [attr.data-level]="level"
      (mouseenter)="onCollapsedItemEnter(item, $event)"
      (mouseleave)="onCollapsedItemLeave(item)"
    >
      <!-- ITEM ROW -->
      <div
        class="menu-link-wrapper"
      [class.parent-active]="isExpanded(item) && !collapsed()"
        matRipple
        [matRippleDisabled]="item.disabled"
      >
        <!-- Selection Indicator Bar -->
        <div class="active-indicator"></div>

        <a
          class="menu-link"
          [routerLink]="item.route || null"
          routerLinkActive="route-active"
          [attr.href]="!item.route ? item.url || null : null"
          (click)="onItemClick(item, $event)"
        >
          @if (item.icon) {
            <mat-icon class="menu-icon">{{ item.icon }}</mat-icon>
          }

          <span class="menu-label" [class.visible]="!collapsed()">
            {{ item.label }}
          </span>

          @if (!collapsed()) {
             <div class="spacer"></div>

             @if (item.badge) {
               <span class="menu-badge" [class]="item.badgeClass || 'badge-default'">
                 {{ item.badge }}
               </span>
             }

             @if (item.children?.length) {
               <mat-icon class="menu-chevron" [class.rotated]="isExpanded(item)">
                 expand_more
               </mat-icon>
             }
          }
        </a>
      </div>


      <!-- SUBMENU (Standard) -->
      @if (item.children?.length && !collapsed()) {
        <ul class="submenu">
          <ng-container
            *ngTemplateOutlet="menuTemplate; context: { $implicit: item.children, level: level + 1 }"
          ></ng-container>
        </ul>
      }
    </li>
  }
</ng-template>

@if (collapsed() && openPopupItem()) {
  <div
    class="collapsed-popup open"
    [style.top.px]="popupTop()"
    [style.left.px]="popupLeft()"
    (mouseenter)="onCollapsedPopupEnter()"
    (mouseleave)="onCollapsedPopupLeave()"
  >
    @if (openPopupItem()?.children?.length) {
      <div class="popup-header">
        @if (openPopupItem()?.icon) {
          <mat-icon class="popup-header-icon">{{ openPopupItem()?.icon }}</mat-icon>
        }
        <span class="popup-header-label">{{ openPopupItem()?.label }}</span>
      </div>
      <ul class="popup-list">
        <ng-container
          *ngTemplateOutlet="collapsedPanelTemplate; context: { $implicit: openPopupItem()?.children || [], level: 0 }"
        ></ng-container>
      </ul>
    } @else {
      <ul class="popup-list">
        <li class="popup-item" [class.active]="isItemActive(openPopupItem())">
          <a
            class="popup-link"
            [routerLink]="openPopupItem()?.route || null"
            [attr.href]="!openPopupItem()?.route ? openPopupItem()?.url || null : null"
            (click)="onSelect(openPopupItem() || null, $event)"
          >
            @if (openPopupItem()?.icon) {
              <mat-icon class="popup-icon">{{ openPopupItem()?.icon }}</mat-icon>
            }
            <span class="popup-label">{{ openPopupItem()?.label }}</span>
          </a>
        </li>
      </ul>
    }
  </div>
}

<!-- RECURSIVE COLLAPSED PANEL TEMPLATE -->
<ng-template #collapsedPanelTemplate let-items let-level="level">
  @for (child of items; track trackById($index, child)) {
    <li class="popup-item" [class.active]="isItemActive(child)" [class.disabled]="child.disabled">
      <a
        class="popup-link"
        [routerLink]="child.route || null"
        [attr.href]="!child.route ? child.url || null : null"
        (click)="onSelect(child, $event)"
      >
        @if (child.icon) {
          <mat-icon class="popup-icon">{{ child.icon }}</mat-icon>
        }
        <span class="popup-label">{{ child.label }}</span>
      </a>
      @if (child.children?.length) {
        <ul class="popup-sublist">
          <ng-container
            *ngTemplateOutlet="collapsedPanelTemplate; context: { $implicit: child.children, level: level + 1 }"
          ></ng-container>
        </ul>
      }
    </li>
  }
</ng-template>
